Final Backend Prompt (Replit) — Arogya AI (FastAPI + SQLite + Gemini + MedGemma)

Build a production-quality MVP backend for “Arogya AI” in Replit using FastAPI. It must match the frontend flows exactly (Landing/Auth is frontend-only; backend starts at patient/records APIs). Implement the endpoints and response shapes exactly as defined below (same as our API contract). Include Gemini for summaries/Q&A and MedGemma for imaging via hosted inference (Replit should NOT attempt to run MedGemma locally).

Tech Stack / Constraints
Python 3.11+
FastAPI + Uvicorn
SQLite (file-based) for persistence
File storage on disk inside Replit: storage/documents/ and storage/images/
CORS enabled, configurable via env
Use .env for config (python-dotenv)
Timestamps: ISO 8601 UTC
Implement consistent JSON error format:
{ "error": { "code": "STRING", "message": "Human readable", "details": {} } }
Required Environment Variables
PORT (Replit provides)
CORS_ORIGINS (comma-separated), must include frontend origin(s)
GEMINI_API_KEY (required)
GEMINI_MODEL (default to a reasonable Gemini model if not set)
HF_TOKEN (required for HF hosted inference)
HF_MODEL_ID (default: medgemma model id you have access to; example: google/medgemma-4b-it)
HF_INFERENCE_ENDPOINT_URL (recommended): full URL to your Hugging Face Inference Endpoint for MedGemma
If not provided, fallback to HF hosted inference API if possible
MAX_UPLOAD_MB (optional; default 20)
Project Structure (create these files)
main.py (FastAPI app + routes)
db.py (SQLite init + connection helpers)
models.py (table creation and basic DB functions)
schemas.py (Pydantic request/response)
services/
files.py (save/upload/stream)
gemini.py (summarize + grounded QA)
medgemma.py (call hosted inference endpoint)
interactions.py (deterministic interaction engine)
audit.py (audit log helper)
requirements.txt
.env.example
storage/documents/, storage/images/ created at startup
Database Schema (SQLite)
Create tables:
patients

id TEXT PRIMARY KEY (pat_<uuid>)
name TEXT NOT NULL
phone TEXT NULL
created_at TEXT NOT NULL
documents

id TEXT PRIMARY KEY (doc_<uuid>)
patient_id TEXT NOT NULL
filename TEXT NOT NULL
mime_type TEXT NOT NULL
submitted_at TEXT NOT NULL
storage_path TEXT NOT NULL
images

id TEXT PRIMARY KEY (img_<uuid>)
patient_id TEXT NOT NULL
filename TEXT NOT NULL
mime_type TEXT NOT NULL
submitted_at TEXT NOT NULL
storage_path TEXT NOT NULL
image_analysis

id TEXT PRIMARY KEY
image_id TEXT NOT NULL
result TEXT NOT NULL
created_at TEXT NOT NULL
summaries

id TEXT PRIMARY KEY
patient_id TEXT NOT NULL
bullets_json TEXT NOT NULL
created_at TEXT NOT NULL
audit_logs

id TEXT PRIMARY KEY
patient_id TEXT NULL
event_type TEXT NOT NULL
payload_json TEXT NOT NULL
created_at TEXT NOT NULL
Endpoints (must match exactly)
5.1 Health
GET /health
200:
{ "status": "ok" }

5.2 Patients
POST /patients
Body: { "name": "string", "phone": "string|null" }
201: Patient
{ "id":"pat_...", "name":"...", "phone":null, "created_at":"..." }

GET /patients
200:
{ "items": [Patient] }

GET /patients/{patientId}
200: Patient
404: NOT_FOUND

5.3 Documents
POST /patients/{patientId}/documents (multipart, field name file)

Save to storage/documents/
Insert row
201:
{
"id":"doc_...",
"patient_id":"pat_...",
"filename":"file.pdf",
"mime_type":"application/pdf",
"submitted_at":"...",
"download_url":"/files/documents/doc_..."
}
GET /patients/{patientId}/documents
200:
{ "items": [Document] }

5.4 Images (MRI/X-ray)
POST /patients/{patientId}/images (multipart, field file)

Save to storage/images/
Insert row
201:
{
"id":"img_...",
"patient_id":"pat_...",
"filename":"scan.png",
"mime_type":"image/png",
"submitted_at":"...",
"download_url":"/files/images/img_..."
}
GET /patients/{patientId}/images
200:
{ "items": [Image] }
Image object should optionally include analysis if exists:
{
...,
"analysis": { "result":"...", "created_at":"..." }
}

POST /patients/{patientId}/images/{imageId}/analyze

Call MedGemma via hosted inference (HF_INFERENCE_ENDPOINT_URL)
Store analysis in image_analysis table
The result MUST include the phrase “Assistive, non-diagnostic”
200:
{ "result": "string", "created_at": "..." }
5.5 AI Summary (Gemini)
POST /patients/{patientId}/summary

If no documents exist: 400 VALIDATION_ERROR
Extract text from PDFs (use a standard PDF text extraction library)
Call Gemini using GEMINI_API_KEY
Prompt must return exactly 5 concise bullets relevant to clinical history (no diagnosis)
Store in summaries table
200:
{ "bullets": ["...","..."], "created_at":"..." }
5.6 Chat-with-Records (Gemini, grounded)
POST /patients/{patientId}/qa
Body: { "question": "string" }

If no documents exist: 400 VALIDATION_ERROR
Must be grounded: build context from extracted text chunks from patient documents
Prompt rules:
answer only from provided context
if not found: “Not found in provided records.”
return citations: filename + optional note (page/section if you can)
200:
{
"answer":"string",
"citations":[{"doc":"filename.pdf","note":"optional"}]
}
5.7 Drug Interaction Check (deterministic + optional Gemini explanation)
POST /safety/interactions/check
Body:
{
"drugs":[{"name":"string","dosage":"string"},{"name":"string","dosage":"string"}],
"patient":{"age":45,"height_cm":170,"weight_kg":70,"additional_info":"string|null"},
"foods":["string"]
}

Behavior:

Deterministic first:
If CSV exists at data/data_final_v5.csv, load it and match interactions
Otherwise use a small built-in interaction list (still deterministic)
Response:
{
"overall":"safe|warning",
"matches":[{"type":"drug-drug|drug-food","a":"...","b":"...","severity":"string|null","note":"string|null"}],
"explanation":"string"
}
If matches exist, explanation can be:
template-based OR Gemini-generated (Gemini allowed here)
Do not prescribe; only warn/explain and suggest “consult clinician/pharmacist”.
5.8 File Downloads
GET /files/documents/{documentId} → stream file
GET /files/images/{imageId} → stream file

Audit Logging (required)
Write audit_logs rows for:
PATIENT_CREATED
DOCUMENT_UPLOADED
IMAGE_UPLOADED
IMAGE_ANALYZED
SUMMARY_GENERATED
QA_ASKED
INTERACTION_CHECKED
Safety / Guardrails (must)
Never output definitive diagnoses.
All imaging outputs must be framed as “Assistive, non-diagnostic”.
If model calls fail, return MODEL_ERROR with safe message and details.
Replit Run Command
Must bind to 0.0.0.0 and use PORT:
uvicorn main:app --host 0.0.0.0 --port $PORT
Deliverables
Fully runnable FastAPI backend in Replit
requirements.txt + .env.example
Clean, consistent responses matching the contract exactly
Minimal logging to console + audit_logs to DB
Do not add any extra endpoints or features beyond the above.

If you share your HF Inference Endpoint URL (for MedGemma) and which Gemini model name you want to use, I can tighten the exact env values + recommended prompts for summary/Q&A to reduce hallucinations.

GPT-5.2 • 1x
